# Databricks notebook source
# MAGIC %md
# MAGIC 
# MAGIC # <span id="uebersicht">Ãœbersicht</span>
# MAGIC ---
# MAGIC ## 1: Vorbereitung
# MAGIC ---
# MAGIC 1.1: Anlegen der Daten<br>
# MAGIC 1.2: Datenmodell<br>
# MAGIC 
# MAGIC ---
# MAGIC ## 2: Einfache Abfragen mit SQL
# MAGIC ---
# MAGIC 2.1: Spalten auswÃ¤hlen<br>
# MAGIC 2.2: DatensÃ¤tze filtern<br>
# MAGIC 2.3: ZÃ¤hlen, Summieren und andere Aggregationen<br>
# MAGIC 2.4: Daten gruppieren<br>
# MAGIC 2.5: Das Ergebnis sortieren<br>
# MAGIC 
# MAGIC ---
# MAGIC ## 3: Erweiterte Abfragen mit SQL
# MAGIC ---
# MAGIC 3.1: VerhÃ¤ltnisgrÃ¶ÃŸen berechnen mit SQL<br>
# MAGIC 3.2: Transformieren von Daten mit SQL<br>
# MAGIC &nbsp;&nbsp;&nbsp;&nbsp;3.2.1: Mehrere Spalten zu einer Spalte zusammenfassen<br>
# MAGIC &nbsp;&nbsp;&nbsp;&nbsp;3.2.2: Eine Spalte zu einer Zeile zusammenfassen<br>
# MAGIC &nbsp;&nbsp;&nbsp;&nbsp;3.2.3: Anreichern der Daten mit weiteren Spalten<br>
# MAGIC &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; a) Regelbasierte Anreicherung<br>
# MAGIC &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; b) Verwendung von Mapping-Tabellen<br>
# MAGIC 
# MAGIC ---
# MAGIC ## 4: Statistische Analysen mit SQL
# MAGIC ---
# MAGIC 4.1: Lageparameter bestimmen<br>
# MAGIC 4.2: ZusammenhÃ¤nge ermitteln<br>
# MAGIC 
# MAGIC ---
# MAGIC ## 5: Komplexe Abfragen mit SQL (nicht Teil dieser Einheit)
# MAGIC ---
# MAGIC 5.1: Abfragen Ã¼ber mehrere Tabellen (JOINs)<br>
# MAGIC 5.2: Mengenoperationen<br>
# MAGIC 5.3: Unterabfragen<br>
# MAGIC 5.4: Window-Funktionen<br>
# MAGIC 
# MAGIC ---
# MAGIC ## Links
# MAGIC ---
# MAGIC ### Fragebogen & Daten
# MAGIC [ðŸ”— Datenmodell Orangenlimonade als XLS](https://docs.google.com/spreadsheets/d/1Sq_CWA-oTN90d0EpA6rEDB3C77dyIXv0HZTq3YWuyy8/edit?usp=sharing)<br>
# MAGIC [ðŸ”— Fragebogen Orangenlimonade inklusive Codierung (PDF)](https://drive.google.com/file/d/1-8aEkgxhgUPgRanEoxIu_2vQQybpLeyO/view?usp=sharing)<br>
# MAGIC 
# MAGIC ### SQL
# MAGIC [ðŸ”— SQL Cheat Sheet](https://docs.google.com/presentation/d/1jgeZ3RKLmgDgiES1UpvQwUKYGGBWEmpNpYXFVEQIh6s/export/pdf)<br>
# MAGIC [ðŸ”— Slides zu SQL aus der Veranstaltung "Information Management"](https://docs.google.com/presentation/d/1Ga31SJKo6KTfMq0m2Z5T7eTmGqMPdBn5cLVnzWHWS4k/export/pdf)<br>
# MAGIC [ðŸ”— Spark SQL Funktionsreferenz](https://spark.apache.org/docs/latest/api/sql/)<br>

# COMMAND ----------

# MAGIC %md
# MAGIC # 1: Vorbereitung
# MAGIC 
# MAGIC Bevor wir loslegen kÃ¶nnen, mÃ¼ssen wir die Daten in eure persÃ¶nlichern Databricks-Accounts laden und uns mit dem Datenmodell vertraut machen.

# COMMAND ----------

# MAGIC %md
# MAGIC ## 1.1: Anlegen der Daten
# MAGIC ---
# MAGIC Den Block unten mÃ¼sset ihr nur einmal ausfÃ¼hren. Der Code legt die benÃ¶tigte Tabelle `limonade` an, mit der wir im Folgenden weiter arbeiten werden.

# COMMAND ----------

# MAGIC %scala
# MAGIC import scala.sys.process._
# MAGIC val tables = Array("limonade")
# MAGIC 
# MAGIC var delimiter = ",";
# MAGIC 
# MAGIC for(t <- tables) {
# MAGIC 
# MAGIC   val tableName = t
# MAGIC   dbutils.fs.rm("file:/tmp/" + tableName + ".csv.gz")
# MAGIC 
# MAGIC   "wget -P /tmp https://s3.amazonaws.com/nicolas.meseth/data+sets/" + tableName + ".csv.gz" !!
# MAGIC 
# MAGIC   val localpath = "file:/tmp/" + tableName + ".csv.gz"
# MAGIC   dbutils.fs.rm("dbfs:/datasets/" + tableName + ".csv.gz")
# MAGIC   dbutils.fs.mkdirs("dbfs:/datasets/")
# MAGIC   dbutils.fs.cp(localpath, "dbfs:/datasets/")
# MAGIC   display(dbutils.fs.ls("dbfs:/datasets/" +  tableName + ".csv.gz"))
# MAGIC 
# MAGIC   sqlContext.sql("drop table if exists " + tableName)
# MAGIC   val df = spark.read.option("header", "true") 
# MAGIC                         .option("inferSchema", "true")
# MAGIC                         .option("sep", delimiter)
# MAGIC                         .option("quote", "\"")
# MAGIC                         .option("escape", "\"")
# MAGIC                         .csv("/datasets/" +  tableName + ".csv.gz")
# MAGIC   df.unpersist()
# MAGIC   df.cache()
# MAGIC   df.write.saveAsTable(tableName);  
# MAGIC }

# COMMAND ----------

# MAGIC %md
# MAGIC ## 1.2: Datenmodell
# MAGIC 
# MAGIC Eine Liste mit allen Spalten kÃ¶nnt ihr [hier als Spreadsheet](https://docs.google.com/spreadsheets/d/1Sq_CWA-oTN90d0EpA6rEDB3C77dyIXv0HZTq3YWuyy8/edit?usp=sharing) einsehen. Alternativ kÃ¶nnt ihr euch die Spalten einer Tabelle auch mithilfe des `describe` Befehls ausgeben lassen.
# MAGIC 
# MAGIC Den Fragebogen kÃ¶nnt ihr hier herunterladen (`Strg` gedrÃ¼ckt halten, um in einem neuen Tab zu Ã¶ffnen): [Fragebogen inklusive Codierung (PDF)](https://drive.google.com/file/d/1-8aEkgxhgUPgRanEoxIu_2vQQybpLeyO/view?usp=sharing)

# COMMAND ----------

# MAGIC %sql
# MAGIC describe limonade

# COMMAND ----------

# MAGIC %md
# MAGIC # 2: Einfache Abfragen mit SQL
# MAGIC SQL ist eine **Abfrage**sprache, die sich gut fÃ¼r strukturierte Daten eignet. Der Begriff "strukturiert" bedeutet in diesem Zusammenhang, dass wir die Daten in Tabellenform vorliegen haben, Ã¤hnlich wie in einem Excel-Spreadsheet. Konkret bedeutet das, dass die Daten in **Spalten** und **Zeilen** vorliegen. Jede Spalte besitzt einen Namen und speichert ein Merkmal bezÃ¼glich der Daten. Die Daten liegen zeilenweise vor, also z.B. reprÃ¤sentiert jede Zeile in der Tabelle einen ausgefÃ¼llten Fragebogen eines Teilnehmers.
# MAGIC 
# MAGIC Wir verwenden den SELECT-Befehl, um Daten abzufragen. Dabei kÃ¶nnen wir mit dem SELECT-Befehl unterschiedliche Methoden anwenden, um das Ergebnis nach unseren WÃ¼nschen zu gestalten. Einige dieser Methoden lernen wir anhand der folgenden Aufgabenstellungen kennen.

# COMMAND ----------

# MAGIC %md
# MAGIC ## 2.1: Spalten auswÃ¤hlen
# MAGIC Eine wichtige Funktion des SELECT-Befehls ist die EinschrÃ¤nkung der Spalten, die im Ergebnis enthalten sind. DatensÃ¤tze enthalten hÃ¤ufig sehr viele Spalten, der hier vorliegende Datensatz hat 274 (!) Spalten. Aber nur wenige sind fÃ¼r die Beantwortung einer Fragestellung tatsÃ¤chlich relevant.

# COMMAND ----------

# MAGIC %md
# MAGIC ### Aufgabe 1
# MAGIC ---
# MAGIC **Erstellt eine SQL-Abfrage, die im Ergebnis nur Informationen zum Studium des Teilnehmers beinhaltet!**

# COMMAND ----------

# MAGIC %md
# MAGIC ### Aufgabe 2
# MAGIC ---
# MAGIC **WÃ¤hlt aus den gesamten Spalten nur die Spalten fÃ¼r die Frage 12 ("Was verbinden Sie spontan mit dem Begriff Orangenlimonade?") aus!**

# COMMAND ----------

# MAGIC %md
# MAGIC ## 2.2: DatensÃ¤tze filtern
# MAGIC SQL lÃ¤sst uns nicht nur bestimmen, welche Spalten wir im Ergebnis sehen wollen, sondern auch, welche **Zeilen**. Um das zu anzugeben, kÃ¶nnen wir so genannte Bedingungen definieren, die fÃ¼r jede Zeile gelten mÃ¼ssen. Gilt eine der Bedingungen nicht, so ist die Zeile nicht im Ergebnis enthalten.
# MAGIC 
# MAGIC Diese Filterbedingungen erstellen leiten wir mit dem SchlÃ¼sselwort `WHERE` ein, gefolgt von ein oder mehreren Bedingungen. Die folgenden Aufgaben bringen uns die WHERE-Klausel nÃ¤her.

# COMMAND ----------

# MAGIC %md
# MAGIC ### Aufgabe 3
# MAGIC ---
# MAGIC **Wir wollen uns nur die Antworten von Teilnehmern ansehen, deren Haushalt mindestens 2 Personen angehÃ¶ren. Filtert die DatensÃ¤tze entsprechend!**
# MAGIC 
# MAGIC âœ“ Die GrÃ¶ÃŸe des Haushalts wird in Frage 48 erfasst.

# COMMAND ----------

# MAGIC %md
# MAGIC ### Aufgabe 4
# MAGIC ---
# MAGIC **Angenommen es interessieren uns nur Antworten von Teilnehmern, die 1990 oder spÃ¤ter geboren wurden. Filtert die DatensÃ¤tze entsprechend!**
# MAGIC 
# MAGIC âœ“ Das Geburtsjahr wird in Frage 39 erfasst.

# COMMAND ----------

# MAGIC %md
# MAGIC ### Aufgabe 5
# MAGIC ---
# MAGIC **Filtert die Daten so, dass nur Teilnehmer mit dem Status "Noch SchÃ¼ler", "Volks-/ Hauptschulabschluss" und "Ohne Abschluss" enthalten sind!**
# MAGIC 
# MAGIC âœ“ Der Schulabschluss wird in Frage 40 erfasst.

# COMMAND ----------

# MAGIC %md
# MAGIC ### Aufgabe 6
# MAGIC ---
# MAGIC **Welche der mÃ¤nnlichen Teilnehmer essen mehrmals pro Woche Fast-Food?**
# MAGIC 
# MAGIC âœ“ Das Geschlecht wird in Frage 53 erfasst.<br>
# MAGIC âœ“ Die ErnÃ¤hrungsgewohnheiten werden in Frage 38 erfasst.

# COMMAND ----------

# MAGIC %md
# MAGIC ## 2.3: ZÃ¤hlen, Summieren und andere Aggregationen
# MAGIC HÃ¤ufig wollen wir aggregierte Werte aus den Daten ermitteln. Jedes Mal wenn wir fragen "*Wie viele...*" fragen wir nach einer Zahl, die letztlich das Ergebnis einer Aggregation der Daten ist. Es gibt viele andere MÃ¶glichkeiten, Daten zu aggregieren. Einige davon lernen wir anhand der folgenden Aufgaben kennen.

# COMMAND ----------

# MAGIC %md
# MAGIC ### Aufgabe 7
# MAGIC ---
# MAGIC **Wie viele Antworten sind im Datensatz insgesamt enthalten?**
# MAGIC 
# MAGIC âœ“ Die Funktion `count()` zÃ¤hlt DatensÃ¤tze!

# COMMAND ----------

# MAGIC %md
# MAGIC ### Aufgabe 8
# MAGIC ---
# MAGIC **Wie groÃŸ ist der grÃ¶ÃŸte Haushalt unter den Antworten?**
# MAGIC 
# MAGIC âœ“ Die GrÃ¶ÃŸe des Haushalts wird in Frage 48 erfasst.<br>
# MAGIC âœ“ `CAST(<col> AS DECIMAL) IS NOT NULL` prÃ¼ft ob der Wert ind er Spalte einen numerischen Wert enthÃ¤lt<br>
# MAGIC âœ“ Die Funktionen `max()` und `min()` sprechen fÃ¼r sich.<br>

# COMMAND ----------

# MAGIC %md
# MAGIC ### Aufgabe 9
# MAGIC ---
# MAGIC **Wie wichtig ist den Teilnehmern Orangenlimonade auf Parties im Durchschnitt?**
# MAGIC 
# MAGIC âœ“ Diese Info findet ihr in Frage 25.<br>
# MAGIC âœ“ Die Funktion `avg()` berechnet das arithmetische Mittel.<br>
# MAGIC âœ“ Vorsicht, ihr mÃ¼sst etwas beachten. Schaut euch mal das Ergebnis an und Ã¼berlegt, ob es valide ist.<br>

# COMMAND ----------

# MAGIC %md
# MAGIC ### Aufgabe 10
# MAGIC ---
# MAGIC **Wie viele Personen leben in Summe in den Haushalten der Befragten?**
# MAGIC 
# MAGIC âœ“ Diese Info findet ihr in Frage 48.<br>
# MAGIC âœ“ Die Funktion `sum()` summiert numerische Daten.<br>

# COMMAND ----------

# MAGIC %md
# MAGIC ### Aufgabe 11
# MAGIC ---
# MAGIC **Aus welchem Geburtsjahrgang stammt der Ã¤lteste Teilnehmer?**
# MAGIC 
# MAGIC âœ“ Das Geburtsjahr wird in Frage 39 erhoben.<br>

# COMMAND ----------

# MAGIC %md
# MAGIC ## 2.4: Daten Gruppieren
# MAGIC 
# MAGIC Wir haben oben Aggregationsfunktionen kennengelernt, die uns jeweils einen Wert zurÃ¼ckliefern. Beispiele waren die Summe, der Durchschnitt oder der grÃ¶ÃŸte Wert der gesamten Daten. Oft reicht aber ein Wert alleine nicht aus, sondern wir brauchen je einen Durchchnittswert pro irgendeiner Untergruppe. Beispielsweise das Durschnittsalter pro Geschlecht.
# MAGIC 
# MAGIC Um das mit SQL zu erreichen nutzen wir so genannte Gruppierungen, die wir auf Basis von Spalten (oder AusdrÃ¼cken) bilden kÃ¶nnen. Wir verwenden hierfÃ¼r das SchlÃ¼sselwort `group by` und nennen dann die zu gruppierenden Spalten (oder AusdrÃ¼cke).

# COMMAND ----------

# MAGIC %md
# MAGIC ### Aufgabe 12
# MAGIC ---
# MAGIC **Wie ist die Verteilung der Postleitzahlen unter den Antworten?**
# MAGIC 
# MAGIC âœ“ Die PLZ wird in Frage 51 erhoben.<br>
# MAGIC âœ“ Erstellt auch eine passende Visualisierung.<br>
# MAGIC âœ“ Stellt sicher, dass nur gÃ¼ltige PLZ im Ergebnis enthalten sind.

# COMMAND ----------

# MAGIC %md
# MAGIC ### Aufgabe 13
# MAGIC ---
# MAGIC **Wie ist die Verteilung der Geschlechter unter den Teilnehmern der Umfrage?**
# MAGIC 
# MAGIC âœ“ Das Geschlecht wird in Frage 53 erhoben.<br>
# MAGIC âœ“ Zeigt die Verteilung der absoluten Zahlen.<br>
# MAGIC âœ“ Erstellt auch eine passende Visualisierung.<br>

# COMMAND ----------

# MAGIC %md
# MAGIC ### Aufgabe 14
# MAGIC ---
# MAGIC **Wie sind die GeburtsjahrgÃ¤nge verteilt?**
# MAGIC 
# MAGIC âœ“ Die Info findet ihr in Frage 39.<br>
# MAGIC âœ“ Zeigt die Verteilung der absoluten Zahlen.<br>
# MAGIC âœ“ Visualisiert das Ergebnis als Balkendiagramm, sortiert nach dem Jahrgang.<br>

# COMMAND ----------

# MAGIC %md
# MAGIC ### Aufgabe 15
# MAGIC ---
# MAGIC **Wie ist die Geschlechterverteilung pro Studiengang?**
# MAGIC 
# MAGIC âœ“ Das Geschlecht wird in Frage 53 erhoben.<br>
# MAGIC âœ“ Der Studiengang wird in Frage 44 erhoben.<br>
# MAGIC âœ“ Zeigt die Verteilung der absoluten Zahlen.<br>

# COMMAND ----------

# MAGIC %md
# MAGIC ## 2.5: Das Ergebnis sortieren
# MAGIC 
# MAGIC Oft ist es notwendig, das Resultat einer SQL Abfrage zu sortieren. HÃ¤ufige Szenarien sind Top-Listen sowie die beste oder schlechteste Zeile im Ergebnis. Die folgenden Aufgaben helfen euch dabei, das Sortieren mit SQL anwenden zu lernen.

# COMMAND ----------

# MAGIC %md
# MAGIC ### Aufgabe 16
# MAGIC ---
# MAGIC **Sortiert die Daten nach dem Alter der Befragten, so dass die Ã„ltesten oben stehen!**

# COMMAND ----------

# MAGIC %md
# MAGIC ### Aufgabe 17
# MAGIC ---
# MAGIC **Welche Einkommensklasse nennt im Durchschnitt den hÃ¶chsten Preis fÃ¼r einen guten Deal (egal welche Limonadensorte)?**
# MAGIC 
# MAGIC âœ“ Die Abfrage von Preisgrenzen erfolgt in Frage 21.<br>
# MAGIC âœ“ Erstellt auch eine passende Visualisierung.<br>

# COMMAND ----------

# MAGIC %md
# MAGIC # 3: Erweiterte Abfragen mit SQL
# MAGIC Der Funktionsumfang von SQL ist weitaus grÃ¶ÃŸer als wir ihn im vorigen Teil kennengelernt haben. Aber auch mit den einfachen Mitteln kÃ¶nnen wir schon sehr viel erreichen. Darum geht es in diesem Abschnitt.

# COMMAND ----------

# MAGIC %md
# MAGIC ## 3.1: VerhÃ¤ltnisgrÃ¶ÃŸen berechnen mit SQL
# MAGIC 
# MAGIC Oft ist eine absolute Zahl nicht aussagekrÃ¤ftig, wenn z.B. die Verteilung der Grundgesamtheit ungleich ist. In diesem Fall sind relative Zahlen - oder VerhÃ¤ltniszahlen - eine sinnvolle KenngrÃ¶ÃŸe. Oft verwendet man fÃ¼r relative Angaben die Prozentangabe (%).
# MAGIC 
# MAGIC In den folgenden Aufgaben versuchen wir, mithilfe von SQL relative HÃ¤ufigkeiten in Prozentangabe zu berechnen.

# COMMAND ----------

# MAGIC %md
# MAGIC ##### Aufgabe 18
# MAGIC ---
# MAGIC ** Wie ist die prozentuale Verteilung zwischen weiblichen und mÃ¤nnlichen Teilnehmern?**
# MAGIC 
# MAGIC âœ“ Die Informationen Ã¼ber das Geschlecht findet ihr in Frage 53.<br>
# MAGIC âœ“ Eine Unterabfrage hilft euch dabei, die Gesamtzahl dynamisch zu ermitteln.<br>

# COMMAND ----------

# MAGIC %md
# MAGIC ##### Aufgabe 19
# MAGIC ---
# MAGIC ** Welcher Prozentsatz der Frauen und MÃ¤nner ernÃ¤hrt sich "bewusst fleischarm"?**
# MAGIC 
# MAGIC âœ“ Die Informationen bezÃ¼glich der ErnÃ¤hrungsweise findet ihr in Frage 47.<br>

# COMMAND ----------

# MAGIC %md
# MAGIC ##### Aufgabe 20
# MAGIC ---
# MAGIC ** Wie ist die prozentuale Verteilung der Geschlechter gruppiert nach hÃ¶chstem Schulabschluss?**
# MAGIC 
# MAGIC âœ“ Das Geschlecht wird in Frage 53 erhoben.<br>
# MAGIC âœ“ Der Schulabschluss wird in Frage 40 erhoben.<br>

# COMMAND ----------

# MAGIC %md
# MAGIC ## 3.2: Transformieren von Daten mit SQL
# MAGIC In vielen FÃ¤llen erhalten wir Rohdaten, die sich ohne eine vorgelagerte Verarbeitung nicht fÃ¼r die Analyse eignen. SQL erlaubt es uns, vielfÃ¤ltige Transformationen der Daten durchzufÃ¼hren, und so das gewÃ¼nschte Format zu erzeugen. Dabei kann man verschiedene Arten von Transformationen unterscheiden. Drei davon, die gerade im Umgang mit empirischen Daten aus FragebÃ¶gen relevant sind, lernen wir in den nÃ¤chsten Aufgabenstellungen kennen.

# COMMAND ----------

# MAGIC %md
# MAGIC ### 3.2.1: Mehrere Spalten zu einer Spalte zusammenfassen
# MAGIC Mit SQL lassen sich mittels AusdrÃ¼cken neue Spalten erzeugen. Diese neuen Spalten kÃ¶nnen Daten aus vorhandenen Spalten verwenden, um neue Erkenntnisse zu gewinnen. Sie kÃ¶nnen aber auch volkommen unabhÃ¤ngig von den existierenden Spalten erzeugt werden. Anhand der folgenden Aufgaben werden wir unterschiedliche Wege kennenlernen, neue Spalten zu erstellen.

# COMMAND ----------

# MAGIC %md
# MAGIC #### Aufgabe 21
# MAGIC ---
# MAGIC ** Wie ist die Verteilung der Antworten aus Frage 1 ("Haben Sie in den letzten 12 Monaten Orangenlimonade gekauft oder getrunken?")?**
# MAGIC 
# MAGIC âœ“ Ãœberlegt, wie ihr die drei Antwortspalten in einer Spalte zusammenfassen kÃ¶nnt!<br>
# MAGIC âœ“ Das `CASE WHEN` Statement kann euch helfen.<br>
# MAGIC âœ“ Erstellt das Diagramm wie unten gezeigt!
# MAGIC 
# MAGIC ![](https://docs.google.com/drawings/d/e/2PACX-1vQO7oUqe5ysC4s9ZFCBfwhMNhrQyAmiosrRJqp1wA6pwtKwI585t37So5Ey5eUrhtHe2J5m5U7SeJnK/pub?w=958&h=448)

# COMMAND ----------

# MAGIC %md
# MAGIC #### Aufgabe 22
# MAGIC ---
# MAGIC **Wie viele _Liter_ Orangenlimonade kauft ein Teilnehmer durchschnittlich pro Woche?**
# MAGIC 
# MAGIC âœ“ Nach der durchschnittlichen Menge wird in Frage 5 gefragt.<br>

# COMMAND ----------

# MAGIC %md
# MAGIC ### 3.2.2: Eine Spalte zu einer Zeile zusammenfassen
# MAGIC Wir kÃ¶nnen mit SQL auch die Werte einer Spalte zu einer *Zeile* zusammenfassen. Das ist nÃ¼tzlich, wenn wir fÃ¼r unterschiedliche AntwortmÃ¶glichkeiten einer Frage jeweils eine Spalte im Datensatz haben. Anhand der folgenden Aufgabe werden wir unterschiedliche Wege kennenlernen, neue Spalten zu erstellen.

# COMMAND ----------

# MAGIC %md
# MAGIC #### Aufgabe 23
# MAGIC ---
# MAGIC ** Wie viele Teilnehmer kaufen in den in Frage 3 angegebenen Markttypen Orangenlimonade ein?**
# MAGIC 
# MAGIC âœ“ Transformiert die Daten zunÃ¤chst! In welcher Form braucht ihr die Daten?<br>
# MAGIC âœ“ Wie geht ihr mit den "Sonstigen" Antworten um?<br>
# MAGIC âœ“ Erstellt eine geeignete Visualisierung

# COMMAND ----------

# MAGIC %md
# MAGIC ### 3.2.3: Anreichern der Daten mit weiteren Spalten
# MAGIC Manchmal ist es sinnvoll, die Daten mit neuen Spalten anzureichern. Z.B. um eine numerische Spalte mit einer textuellen Beschreibung zu ergÃ¤nzen. Je nach KomplexitÃ¤t gibt es 2 MÃ¶glichkeiten, Spalten anzureichern:<br><br>
# MAGIC 
# MAGIC 1. Regelbasiert mit dem `CASE WHEN` Befehl
# MAGIC 2. Ãœber Mappingtabellen
# MAGIC 
# MAGIC Beide MÃ¶glichkeiten wenden wir in den folgenden Aufgaben an.

# COMMAND ----------

# MAGIC %md
# MAGIC #### Aufgabe 24
# MAGIC ---
# MAGIC **Wie ist die Verteilung der Antworten bei Frage 4 ("Wie hÃ¤ufig konsumieren Sie Orangenlimonade?")**
# MAGIC 
# MAGIC âœ“ Erstellt eine Visualisierung mit den textuellen AntwortmÃ¶glichkeiten in der Reihenfolge wie im Fragebogen!<br>
# MAGIC âœ“ Zeigt auf der Y-Achse die absolute HÃ¤ufigkeit fÃ¼r jede AntwortmÃ¶glichkeit dar!<br>
# MAGIC âœ“ Reichert die textuelle Information mittels `CASE WHEN` Regeln an!<br>

# COMMAND ----------

# MAGIC %md
# MAGIC #### Aufgabe 25
# MAGIC ---
# MAGIC **Vergleicht die Angaben zu einem "angenehmen Preis" fÃ¼r jede der drei Limonadenmarken aus dem Fragebogen mit den tatsÃ¤chlichen Preisen!**
# MAGIC 
# MAGIC âœ“ Die Informationen zu den Preisangaben der Teilnehmer findet ihr in Frage 18.<br>
# MAGIC âœ“ Die tatsÃ¤chlichen Preise befinden sich in der Tabelle `limonade_prices`, die ihr als Mappingtabelle einbinden sollt.<br>
# MAGIC âœ“ Im SQL Block unten wird diese Tabelle als temporÃ¤rer View angelegt (einmal ausfÃ¼hren).<br>

# COMMAND ----------

# MAGIC %sql
# MAGIC -- Anlegen der Mappingtabelle
# MAGIC create or replace temporary view limonade_prices as
# MAGIC select 'Fritz' as brand, 0.85 as price 
# MAGIC union
# MAGIC select 'Fanta' as brand, 0.59 as price
# MAGIC union  
# MAGIC select 'Vio' as brand, 0.75 as price

# COMMAND ----------

# MAGIC %md
# MAGIC # 4: Statistische Analysen mit SQL
# MAGIC Einfache statistische Analysen zÃ¤hlen auch zum Repertoire von SQL. Wir lernen in diesem Abschnitt ein paar kennen.

# COMMAND ----------

# MAGIC %md
# MAGIC ## 4.1: Lageparameter bestimmen
# MAGIC Statistische Lageparameter geben einen Ãœberblick Ã¼ber die Werteverteilung eines Merkmals. Gut bekannt sind das arithmetische Mittel oder der Median. Mittels SQL lassen sich die gÃ¤ngigsten Parameter auf einfache Weise bestimmen. In den folgenden Aufgaben wenden wir einige Funktionen zur Bestimmung von Lageparametern an.

# COMMAND ----------

# MAGIC %md
# MAGIC ### Aufgabe 26
# MAGIC ---
# MAGIC ** Ermittelt die wichtigsten Lageparameter fÃ¼r die Zustimmung zur Aussage "Allgemein kann man sagen, dass ein hÃ¶herer Preis auch eine hÃ¶here QualitÃ¤t bedeutet"!**
# MAGIC 
# MAGIC âœ“ Die Informationen zu dieser Aussage findet ihr in Frage 43.<br>
# MAGIC âœ“ Was sind eurer Meinung nach gÃ¤ngige Lageparametr? Schaut in der [Funktionsreferenz](https://spark.apache.org/docs/latest/api/sql/) nach passenden SQL Funktionen!<br>

# COMMAND ----------

# MAGIC %md
# MAGIC ### Aufgabe 27
# MAGIC ---
# MAGIC ** In Frage 12 wird nach den Begriffen gefragt, die spontan mit Orangenlimonade verbunden werden. Erstellt eine Tabelle, in der je eine Zeile pro abgefragten Begriff enthalten ist. In den Spalten sollen Lageparameter zur Wahrscheinlichkeit, dass der Begriff genannt wurde, enthalten sein.**
# MAGIC 
# MAGIC âœ“ Errechnet im ersten Schritt die prozentualen Anteile nach Geschlecht.<br>
# MAGIC âœ“ Ãœberlegt welche weiteren Schritte notwendig sind.<br>
# MAGIC âœ“ Die Infos werden in den Fragen 47 und 53 erfasst.<br>
# MAGIC âœ“ Mithilfe von Variablen kÃ¶nnt ihr die SQL-Abfrage flexibel verwenden. Variablen kÃ¶nnt ihr mit `${name}` einbinden.<br>

# COMMAND ----------

# MAGIC %md
# MAGIC ### Aufgabe 28
# MAGIC ---
# MAGIC ** Stellt die wichtigsten Lageparameter fÃ¼r die 9 Beschreibungen bezÃ¼glich der Etiketten von Orangenlimonade aus Frage 28 grafisch dar!**
# MAGIC 
# MAGIC âœ“ Welche Art der Darstellung ist geeignet?
# MAGIC âœ“ Welche Datengrundlage benÃ¶tigt ihr dafÃ¼r?

# COMMAND ----------

# MAGIC %md
# MAGIC ## 4.2: ZusammenhÃ¤nge ermitteln
# MAGIC Der Hauptgrund fÃ¼r die Datenanalyse ist die Suche nach ZusammenhÃ¤ngen. Welche Merkmale wirken sich in welcher Weise aufeinander aus? SQL ermÃ¶glicht die Schaffung der Datenbasis, um Hypothesen Ã¼ber ZusammenhÃ¤nge mit faktenbasiert zu Ã¼berprÃ¼fen. Die folgenden Aufgaben stellen implizit eine Hypothese auf, fÃ¼r die ihr in den Daten nach Belegen suchen sollt.
# MAGIC 
# MAGIC Bei ZusammenhÃ¤ngen ergibt eine Visualisierung fast immer Sinn. Ãœberlegt euch fÃ¼r jede Aufgabe, welche am besten geeignet ist. Ãœberlegt euch auch, welche Kennzahlen ihr errechnen kÃ¶nnt, um den Zusammenhang statistisch zu untermauern.

# COMMAND ----------

# MAGIC %md
# MAGIC ### Aufgabe 29
# MAGIC ---
# MAGIC ** Gibt es einen Zusammenhang zwischen dem Geschlecht und dem Verfolgen einer bestimmten ErnÃ¤hrungweise?**
# MAGIC 
# MAGIC âœ“ Errechnet im ersten Schritt die prozentualen Anteile nach Geschlecht.<br>
# MAGIC âœ“ Ãœberlegt welche weiteren Schritte notwendig sind.<br>
# MAGIC âœ“ Die Infos werden in den Fragen 47 und 53 erfasst.<br>
# MAGIC âœ“ Mithilfe von Variablen kÃ¶nnt ihr die SQL-Abfrage flexibel verwenden. Variablen kÃ¶nnt ihr mit `${name}` einbinden.<br>

# COMMAND ----------

# MAGIC %md
# MAGIC ### Aufgabe 30
# MAGIC ---
# MAGIC ** Essen MÃ¤nner mit einer hÃ¶heren Wahrscheinlichkeit mehrmals pro Woche Fast-Food als Frauen? **
# MAGIC 
# MAGIC âœ“ Das Geschlecht wird in Frage 53 erfasst.<br>
# MAGIC âœ“ Die ErnÃ¤hrungsgewohnheiten werden in Frage 38 erfasst.

# COMMAND ----------

# MAGIC %md
# MAGIC ### Aufgabe 31
# MAGIC ---
# MAGIC ** KÃ¶nnt ihr einen Zusammenhang zwischen dem Haushaltseinkommen und dem Alter anhand der Daten feststellen?**
# MAGIC 
# MAGIC âœ“ Das Haushaltseinkommen wird in Frage 52 erhoben.<br>
# MAGIC âœ“ Das Geburtsjahr wird in Frage 39 erhoben.
